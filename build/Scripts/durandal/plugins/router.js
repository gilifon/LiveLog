define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,g,n,a,o,t,L,s){function l(e){return e=e.replace(v,"\\$&").replace(u,"(?:$1)?").replace(d,function(e,g){return g?e:"([^/]+)"}).replace(f,"(.*?)"),new RegExp("^"+e+"$")}function p(e){var g=e.indexOf(":"),n=g>0?g-1:e.length;return e.substring(0,n)}function m(e){return e.router&&e.router.loadUrl}function w(e,g){return-1!==e.indexOf(g,e.length-g.length)}function r(e,g){if(!e||!g)return!1;if(e.length!=g.length)return!1;for(var n=0,a=e.length;a>n;n++)if(e[n]!=g[n])return!1;return!0}var i,c,u=/\((.*?)\)/g,d=/(\(\?)?:\w+/g,f=/\*\w+/g,v=/[\-{}\[\]+?.,\\\^$|#\s]/g,h=/\/$/,b=function(){function o(g,n){e.log("Navigation Complete",g,n);var a=e.getModuleId(x);a&&T.trigger("router:navigation:from:"+a),x=g,D=n;var o=e.getModuleId(x);o&&T.trigger("router:navigation:to:"+o),m(g)||T.updateDocumentTitle(g,n),c.explicitNavigation=!1,c.navigatingBack=!1,T.trigger("router:navigation:complete",g,n,T)}function s(g,n){e.log("Navigation Cancelled"),T.activeInstruction(D),D&&T.navigate(D.fragment,!1),E(!1),c.explicitNavigation=!1,c.navigatingBack=!1,T.trigger("router:navigation:cancelled",g,n,T)}function u(g){e.log("Navigation Redirecting"),E(!1),c.explicitNavigation=!1,c.navigatingBack=!1,T.navigate(g,{trigger:!0,replace:!0})}function d(e,g,n){c.navigatingBack=!c.explicitNavigation&&x!=n.fragment,T.trigger("router:route:activating",g,n,T),e.activateItem(g,n.params).then(function(a){if(a){var t=x;o(g,n),m(g)&&k({router:g.router,fragment:n.fragment,queryString:n.queryString}),t==g&&T.attached()}else e.settings.lifecycleData&&e.settings.lifecycleData.redirect?u(e.settings.lifecycleData.redirect):s(g,n);i&&(i.resolve(),i=null)})}function f(g,n,a){var o=T.guardRoute(n,a);o?o.then?o.then(function(o){o?e.isString(o)?u(o):d(g,n,a):s(n,a)}):e.isString(o)?u(o):d(g,n,a):s(n,a)}function v(e,g,n){T.guardRoute?f(e,g,n):d(e,g,n)}function y(e){return D&&D.config.moduleId==e.config.moduleId&&x&&(x.canReuseForRoute&&x.canReuseForRoute.apply(x,e.params)||x.router&&x.router.loadUrl)}function S(){if(!E()){var g=O.shift();if(O=[],g){if(g.router){var a=g.fragment;return g.queryString&&(a+="?"+g.queryString),g.router.loadUrl(a),void 0}E(!0),T.activeInstruction(g),y(g)?v(n.create(),x,g):e.acquire(g.config.moduleId).then(function(n){var a=e.resolveObject(n);v(P,a,g)}).fail(function(n){e.error("Failed to load routed module ("+g.config.moduleId+"). Details: "+n.message)})}}}function k(e){O.unshift(e),S()}function A(e,g,n){for(var a=e.exec(g).slice(1),o=0;o<a.length;o++){var t=a[o];a[o]=t?decodeURIComponent(t):null}var L=T.parseQueryString(n);return L&&a.push(L),{params:a,queryParams:L}}function C(g){T.trigger("router:route:before-config",g,T),e.isRegExp(g)?g.routePattern=g.route:(g.title=g.title||T.convertRouteToTitle(g.route),g.moduleId=g.moduleId||T.convertRouteToModuleId(g.route),g.hash=g.hash||T.convertRouteToHash(g.route),g.routePattern=l(g.route)),T.trigger("router:route:after-config",g,T),T.routes.push(g),T.route(g.routePattern,function(e,n){var a=A(g.routePattern,e,n);k({fragment:e,queryString:n,config:g,params:a.params,queryParams:a.queryParams})})}function _(g){if(e.isArray(g.route))for(var n=0,a=g.route.length;a>n;n++){var o=e.extend({},g);o.route=g.route[n],n>0&&delete o.nav,C(o)}else C(g);return T}function I(e){e.isActive||(e.isActive=L.computed(function(){var g=P();return g&&g.__moduleId__==e.moduleId}))}var x,D,O=[],E=L.observable(!1),P=n.create(),T={handlers:[],routes:[],navigationModel:L.observableArray([]),activeItem:P,isNavigating:L.computed(function(){var e=P(),g=E(),n=e&&e.router&&e.router!=T&&e.router.isNavigating()?!0:!1;return g||n}),activeInstruction:L.observable(null),__router__:!0};return a.includeIn(T),P.settings.areSameItem=function(e,g,n,a){return e==g?r(n,a):!1},T.parseQueryString=function(e){var g,n;if(!e)return null;if(n=e.split("&"),0==n.length)return null;g={};for(var a=0;a<n.length;a++){var o=n[a];if(""!==o){var t=o.split("=");g[t[0]]=t[1]&&decodeURIComponent(t[1].replace(/\+/g," "))}}return g},T.route=function(e,g){T.handlers.push({routePattern:e,callback:g})},T.loadUrl=function(g){var n=T.handlers,a=null,o=g,L=g.indexOf("?");if(-1!=L&&(o=g.substring(0,L),a=g.substr(L+1)),T.relativeToParentRouter){var s=this.parent.activeInstruction();o=s.params.join("/"),o&&"/"==o[0]&&(o=o.substr(1)),o||(o=""),o=o.replace("//","/").replace("//","/")}o=o.replace(h,"");for(var l=0;l<n.length;l++){var p=n[l];if(p.routePattern.test(o))return p.callback(o,a),!0}return e.log("Route Not Found"),T.trigger("router:route:not-found",g,T),D&&t.navigate(D.fragment,{trigger:!1,replace:!0}),c.explicitNavigation=!1,c.navigatingBack=!1,!1},T.updateDocumentTitle=function(e,n){n.config.title?document.title=g.title?n.config.title+" | "+g.title:n.config.title:g.title&&(document.title=g.title)},T.navigate=function(e,g){return e&&-1!=e.indexOf("://")?(window.location.href=e,!0):(c.explicitNavigation=!0,t.navigate(e,g))},T.navigateBack=function(){t.navigateBack()},T.attached=function(){setTimeout(function(){E(!1),T.trigger("router:navigation:attached",x,D,T),S()},10)},T.compositionComplete=function(){T.trigger("router:navigation:composition-complete",x,D,T)},T.convertRouteToHash=function(e){if(T.relativeToParentRouter){var g=T.parent.activeInstruction(),n=g.config.hash+"/"+e;return t._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return t._hasPushState?e:"#"+e},T.convertRouteToModuleId=function(e){return p(e)},T.convertRouteToTitle=function(e){var g=p(e);return g.substring(0,1).toUpperCase()+g.substring(1)},T.map=function(g,n){if(e.isArray(g)){for(var a=0;a<g.length;a++)T.map(g[a]);return T}return e.isString(g)||e.isRegExp(g)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=g):n=g,_(n)},T.buildNavigationModel=function(g){var n=[],a=T.routes;g=g||100;for(var o=0;o<a.length;o++){var t=a[o];t.nav&&(e.isNumber(t.nav)||(t.nav=g),I(t),n.push(t))}return n.sort(function(e,g){return e.nav-g.nav}),T.navigationModel(n),T},T.mapUnknownRoutes=function(g,n){var a="*catchall",o=l(a);return T.route(o,function(L,s){var l=A(o,L,s),p={fragment:L,queryString:s,config:{route:a,routePattern:o},params:l.params,queryParams:l.queryParams};if(g)if(e.isString(g))p.config.moduleId=g,n&&t.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(g)){var m=g(p);if(m&&m.then)return m.then(function(){T.trigger("router:route:before-config",p.config,T),T.trigger("router:route:after-config",p.config,T),k(p)}),void 0}else p.config=g,p.config.route=a,p.config.routePattern=o;else p.config.moduleId=L;T.trigger("router:route:before-config",p.config,T),T.trigger("router:route:after-config",p.config,T),k(p)}),T},T.reset=function(){return D=x=void 0,T.handlers=[],T.routes=[],T.off(),delete T.options,T},T.makeRelative=function(g){return e.isString(g)&&(g={moduleId:g,route:g}),g.moduleId&&!w(g.moduleId,"/")&&(g.moduleId+="/"),g.route&&!w(g.route,"/")&&(g.route+="/"),g.fromParent&&(T.relativeToParentRouter=!0),T.on("router:route:before-config").then(function(e){g.moduleId&&(e.moduleId=g.moduleId+e.moduleId),g.route&&(e.route=""===e.route?g.route.substring(0,g.route.length-1):g.route+e.route)}),T},T.createChildRouter=function(){var e=b();return e.parent=T,e},T};return c=b(),c.explicitNavigation=!1,c.navigatingBack=!1,c.activate=function(g){return e.defer(function(n){if(i=n,c.options=e.extend({routeHandler:c.loadUrl},c.options,g),t.activate(c.options),t._hasPushState)for(var a=c.routes,o=a.length;o--;){var L=a[o];L.hash=L.hash.replace("#","")}s(document).delegate("a","click",function(e){if(c.explicitNavigation=!0,t._hasPushState&&!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var g=s(this).attr("href"),n=this.protocol+"//";(!g||"#"!==g.charAt(0)&&g.slice(n.length)!==n)&&(e.preventDefault(),t.navigate(g))}})}).promise()},c.deactivate=function(){t.deactivate()},c.install=function(){L.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,g,n,a,t){var s=L.utils.unwrapObservable(g())||{};if(s.__router__)s={model:s.activeItem(),attached:s.attached,compositionComplete:s.compositionComplete,activate:!1};else{var l=L.utils.unwrapObservable(s.router||a.router)||c;s.model=l.activeItem(),s.attached=l.attached,s.compositionComplete=l.compositionComplete,s.activate=!1}o.compose(e,s,t)}},L.virtualElements.allowedBindings.router=!0},c});