define(["durandal/system","jquery"],function(g,e){function n(g,e,n){if(n){var a=g.href.replace(/(javascript:|#).*$/,"");g.replace(a+"#"+e)}else g.hash="#"+e}var a=/^[#\/]|\s+$/g,o=/^\/+|\/+$/g,t=/msie [\w.]+/,L=/\/$/,s={interval:50,active:!1};return"undefined"!=typeof window&&(s.location=window.location,s.history=window.history),s.getHash=function(g){var e=(g||s).location.href.match(/#(.*)$/);return e?e[1]:""},s.getFragment=function(g,e){if(null==g)if(s._hasPushState||!s._wantsHashChange||e){g=s.location.pathname;var n=s.root.replace(L,"");g.indexOf(n)||(g=g.substr(n.length))}else g=s.getHash();return g.replace(a,"")},s.activate=function(n){s.active&&g.error("History has already been activated."),s.active=!0,s.options=g.extend({},{root:"/"},s.options,n),s.root=s.options.root,s._wantsHashChange=s.options.hashChange!==!1,s._wantsPushState=!!s.options.pushState,s._hasPushState=!!(s.options.pushState&&s.history&&s.history.pushState);var L=s.getFragment(),l=document.documentMode,p=t.exec(navigator.userAgent.toLowerCase())&&(!l||7>=l);s.root=("/"+s.root+"/").replace(o,"/"),p&&s._wantsHashChange&&(s.iframe=e('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,s.navigate(L,!1)),s._hasPushState?e(window).on("popstate",s.checkUrl):s._wantsHashChange&&"onhashchange"in window&&!p?e(window).on("hashchange",s.checkUrl):s._wantsHashChange&&(s._checkUrlInterval=setInterval(s.checkUrl,s.interval)),s.fragment=L;var m=s.location,w=m.pathname.replace(/[^\/]$/,"$&/")===s.root;if(s._wantsHashChange&&s._wantsPushState){if(!s._hasPushState&&!w)return s.fragment=s.getFragment(null,!0),s.location.replace(s.root+s.location.search+"#"+s.fragment),!0;s._hasPushState&&w&&m.hash&&(this.fragment=s.getHash().replace(a,""),this.history.replaceState({},document.title,s.root+s.fragment+m.search))}return s.options.silent?void 0:s.loadUrl()},s.deactivate=function(){e(window).off("popstate",s.checkUrl).off("hashchange",s.checkUrl),clearInterval(s._checkUrlInterval),s.active=!1},s.checkUrl=function(){var g=s.getFragment();return g===s.fragment&&s.iframe&&(g=s.getFragment(s.getHash(s.iframe))),g===s.fragment?!1:(s.iframe&&s.navigate(g,!1),s.loadUrl(),void 0)},s.loadUrl=function(g){var e=s.fragment=s.getFragment(g);return s.options.routeHandler?s.options.routeHandler(e):!1},s.navigate=function(e,a){if(!s.active)return!1;if(void 0===a?a={trigger:!0}:g.isBoolean(a)&&(a={trigger:a}),e=s.getFragment(e||""),s.fragment!==e){s.fragment=e;var o=s.root+e;if(s._hasPushState)s.history[a.replace?"replaceState":"pushState"]({},document.title,o);else{if(!s._wantsHashChange)return s.location.assign(o);n(s.location,e,a.replace),s.iframe&&e!==s.getFragment(s.getHash(s.iframe))&&(a.replace||s.iframe.document.open().close(),n(s.iframe.location,e,a.replace))}return a.trigger?s.loadUrl(e):void 0}},s.navigateBack=function(){s.history.back()},s});