define(["durandal/system","durandal/composition","jquery","knockout"],function(e,g,n,a){function o(e,n){var o=a.utils.domData.get(e,l);o||(o={parts:g.cloneNodes(a.virtualElements.childNodes(e))},a.virtualElements.emptyNode(e),a.utils.domData.set(e,l,o)),n.parts=o.parts}var t={},L={},s=["model","view","kind"],l="durandal-widget-data",p={getSettings:function(g){var n=a.utils.unwrapObservable(g())||{};if(e.isString(n))return{kind:n};for(var o in n)n[o]=-1!=a.utils.arrayIndexOf(s,o)?a.utils.unwrapObservable(n[o]):n[o];return n},registerKind:function(e){a.bindingHandlers[e]={init:function(){return{controlsDescendantBindings:!0}},update:function(g,n,a,t,L){var s=p.getSettings(n);s.kind=e,o(g,s),p.create(g,s,L,!0)}},a.virtualElements.allowedBindings[e]=!0},mapKind:function(e,g,n){g&&(L[e]=g),n&&(t[e]=n)},mapKindToModuleId:function(e){return t[e]||p.convertKindToModulePath(e)},convertKindToModulePath:function(e){return"widgets/"+e+"/viewmodel"},mapKindToViewId:function(e){return L[e]||p.convertKindToViewPath(e)},convertKindToViewPath:function(e){return"widgets/"+e+"/view"},createCompositionSettings:function(e,g){return g.model||(g.model=this.mapKindToModuleId(g.kind)),g.view||(g.view=this.mapKindToViewId(g.kind)),g.preserveContext=!0,g.activate=!0,g.activationData=g,g.mode="templated",g},create:function(e,n,a,o){o||(n=p.getSettings(function(){return n},e));var t=p.createCompositionSettings(e,n);g.compose(e,t,a)},install:function(e){if(e.bindingName=e.bindingName||"widget",e.kinds)for(var g=e.kinds,n=0;n<g.length;n++)p.registerKind(g[n]);a.bindingHandlers[e.bindingName]={init:function(){return{controlsDescendantBindings:!0}},update:function(e,g,n,a,t){var L=p.getSettings(g);o(e,L),p.create(e,L,t,!0)}},a.virtualElements.allowedBindings[e.bindingName]=!0}};return p});