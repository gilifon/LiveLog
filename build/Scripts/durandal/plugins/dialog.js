define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(g,e,n,o,a,L,t){function s(e){return g.defer(function(n){g.isString(e)?g.acquire(e).then(function(e){n.resolve(g.resolveObject(e))}).fail(function(n){g.error("Failed to load dialog module ("+e+"). Details: "+n.message)}):n.resolve(e)}).promise()}var l,p={},m=0,w=function(g,e,n){this.message=g,this.title=e||w.defaultTitle,this.options=n||w.defaultOptions};return w.prototype.selectOption=function(g){l.close(this,g)},w.prototype.getView=function(){return a.processMarkup(w.defaultViewMarkup)},w.setViewUrl=function(g){delete w.prototype.getView,w.prototype.viewUrl=g},w.defaultTitle=e.title||"Application",w.defaultOptions=["Ok"],w.defaultViewMarkup=['<div data-view="plugins/messageBox" class="messageBox">','<div class="modal-header">','<h3 data-bind="text: title"></h3>',"</div>",'<div class="modal-body">','<p class="message" data-bind="text: message"></p>',"</div>",'<div class="modal-footer" data-bind="foreach: options">','<button class="btn" data-bind="click: function () { $parent.selectOption($data); }, text: $data, css: { \'btn-primary\': $index() == 0, autofocus: $index() == 0 }"></button>',"</div>","</div>"].join("\n"),l={MessageBox:w,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:function(){return m>0},getContext:function(g){return p[g||"default"]},addContext:function(g,e){e.name=g,p[g]=e;var n="show"+g.substr(0,1).toUpperCase()+g.substr(1);this[n]=function(e,n){return this.show(e,n,g)}},createCompositionSettings:function(g,e){var n={model:g,activate:!1};return e.attached&&(n.attached=e.attached),e.compositionComplete&&(n.compositionComplete=e.compositionComplete),n},getDialog:function(g){return g?g.__dialog__:void 0},close:function(g){var e=this.getDialog(g);if(e){var n=Array.prototype.slice.call(arguments,1);e.close.apply(e,n)}},show:function(e,a,L){var t=this,l=p[L||"default"];return g.defer(function(g){s(e).then(function(e){var L=o.create();L.activateItem(e,a).then(function(o){if(o){var a=e.__dialog__={owner:e,context:l,activator:L,close:function(){var n=arguments;L.deactivateItem(e,!0).then(function(o){o&&(m--,l.removeHost(a),delete e.__dialog__,0==n.length?g.resolve():1==n.length?g.resolve(n[0]):g.resolve.apply(g,n))})}};a.settings=t.createCompositionSettings(e,l),l.addHost(a),m++,n.compose(a.host,a.settings)}else g.resolve(!1)})})}).promise()},showMessage:function(e,n,o){return g.isString(this.MessageBox)?l.show(this.MessageBox,[e,n||w.defaultTitle,o||w.defaultOptions]):l.show(new this.MessageBox(e,n,o))},install:function(g){e.showDialog=function(g,e,n){return l.show(g,e,n)},e.showMessage=function(g,e,n){return l.showMessage(g,e,n)},g.messageBox&&(l.MessageBox=g.messageBox),g.messageBoxView&&(l.MessageBox.prototype.getView=function(){return g.messageBoxView})}},l.addContext("default",{blockoutOpacity:.2,removeDelay:200,addHost:function(g){var e=L("body"),n=L('<div class="modalBlockout"></div>').css({"z-index":l.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(e),o=L('<div class="modalHost"></div>').css({"z-index":l.getNextZIndex()}).appendTo(e);if(g.host=o.get(0),g.blockout=n.get(0),!l.isOpen()){g.oldBodyMarginRight=e.css("margin-right"),g.oldInlineMarginRight=e.get(0).style.marginRight;var a=L("html"),t=e.outerWidth(!0),s=a.scrollTop();L("html").css("overflow-y","hidden");var p=L("body").outerWidth(!0);e.css("margin-right",p-t+parseInt(g.oldBodyMarginRight)+"px"),a.scrollTop(s)}},removeHost:function(g){if(L(g.host).css("opacity",0),L(g.blockout).css("opacity",0),setTimeout(function(){t.removeNode(g.host),t.removeNode(g.blockout)},this.removeDelay),!l.isOpen()){var e=L("html"),n=e.scrollTop();e.css("overflow-y","").scrollTop(n),g.oldInlineMarginRight?L("body").css("margin-right",g.oldBodyMarginRight):L("body").css("margin-right","")}},compositionComplete:function(g,e,n){var o=L(g),a=o.width(),t=o.height(),s=l.getDialog(n.model);o.css({"margin-top":(-t/2).toString()+"px","margin-left":(-a/2).toString()+"px"}),L(s.host).css("opacity",1),L(g).hasClass("autoclose")&&L(s.blockout).click(function(){s.close()}),L(".autofocus",g).each(function(){L(this).focus()})}}),l});